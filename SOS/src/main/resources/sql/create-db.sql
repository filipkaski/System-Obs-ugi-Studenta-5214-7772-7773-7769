-- USUWANIE ISTNIEJÄ„CYCH TABEL
DROP TABLE IF EXISTS PUBLIC.WYPOZYCZENIE;
DROP TABLE IF EXISTS PUBLIC.KSIAZKA;
DROP TABLE IF EXISTS PUBLIC.WPLATA;
DROP TABLE IF EXISTS PUBLIC.NALEZNOSC;
DROP TABLE IF EXISTS PUBLIC.OCENA;
DROP TABLE IF EXISTS PUBLIC.ZAPIS;
DROP TABLE IF EXISTS PUBLIC.OKNO_ZAPISOW;
DROP TABLE IF EXISTS PUBLIC.ZAJECIA;
DROP TABLE IF EXISTS PUBLIC.SALA;
DROP TABLE IF EXISTS PUBLIC.ZGODA_PROWADZACEGO;
DROP TABLE IF EXISTS PUBLIC.WYMAGANIE_WSTEPNE;
DROP TABLE IF EXISTS PUBLIC.PRZEDMIOT_PROWADZACY;
DROP TABLE IF EXISTS PUBLIC.PRZEDMIOT;
DROP TABLE IF EXISTS PUBLIC.PROWADZACY;
DROP TABLE IF EXISTS PUBLIC.STUDENT;
DROP TABLE IF EXISTS PUBLIC.UZYTKOWNIK;

-- DEFINICJE TABEL

CREATE TABLE PUBLIC.UZYTKOWNIK(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    EMAIL VARCHAR(120) NOT NULL,
    HASLO_HASH VARCHAR(255) NOT NULL,
    STATUS VARCHAR(20) NOT NULL,
    DATA_UTWORZENIA TIMESTAMP NOT NULL,
    OSTATNIE_LOGOWANIE TIMESTAMP,
    NIEUDANE_LOGOWANIA INTEGER NOT NULL,
    BLOKADA_DO TIMESTAMP,
    CONSTRAINT UQ_UZYTKOWNIK_EMAIL UNIQUE(EMAIL)
);

CREATE TABLE PUBLIC.STUDENT(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    UZYTKOWNIK_ID INTEGER NOT NULL,
    NR_INDEKSU VARCHAR(20) NOT NULL,
    IMIE VARCHAR(60) NOT NULL,
    NAZWISKO VARCHAR(80) NOT NULL,
    KIERUNEK VARCHAR(120) NOT NULL,
    ROK INTEGER NOT NULL,
    CONSTRAINT UQ_STUDENT_UZYTKOWNIK UNIQUE(UZYTKOWNIK_ID),
    CONSTRAINT UQ_STUDENT_INDEKS UNIQUE(NR_INDEKSU),
    CONSTRAINT FK_STUDENT_UZYTKOWNIK FOREIGN KEY(UZYTKOWNIK_ID) REFERENCES PUBLIC.UZYTKOWNIK(ID)
);

CREATE TABLE PUBLIC.PROWADZACY(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    IMIE VARCHAR(60) NOT NULL,
    NAZWISKO VARCHAR(80) NOT NULL,
    EMAIL VARCHAR(120),
    CONSTRAINT UQ_PROWADZACY_EMAIL UNIQUE(EMAIL)
);

CREATE TABLE PUBLIC.PRZEDMIOT(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    KOD VARCHAR(20) NOT NULL,
    NAZWA VARCHAR(200) NOT NULL,
    ECTS INTEGER NOT NULL,
    SEMESTR INTEGER NOT NULL,
    CONSTRAINT UQ_PRZEDMIOT_KOD UNIQUE(KOD)
);

CREATE TABLE PUBLIC.PRZEDMIOT_PROWADZACY(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    PRZEDMIOT_ID INTEGER NOT NULL,
    PROWADZACY_ID INTEGER NOT NULL,
    CONSTRAINT FK_PP_PRZEDMIOT FOREIGN KEY(PRZEDMIOT_ID) REFERENCES PUBLIC.PRZEDMIOT(ID),
    CONSTRAINT FK_PP_PROWADZACY FOREIGN KEY(PROWADZACY_ID) REFERENCES PUBLIC.PROWADZACY(ID),
    CONSTRAINT UQ_PP UNIQUE(PRZEDMIOT_ID, PROWADZACY_ID)
);

CREATE TABLE PUBLIC.WYMAGANIE_WSTEPNE(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    PRZEDMIOT_ID INTEGER NOT NULL,
    WYMAGANY_PRZEDMIOT_ID INTEGER NOT NULL,
    CONSTRAINT FK_WW_PRZEDMIOT FOREIGN KEY(PRZEDMIOT_ID) REFERENCES PUBLIC.PRZEDMIOT(ID),
    CONSTRAINT FK_WW_WYMAGANY FOREIGN KEY(WYMAGANY_PRZEDMIOT_ID) REFERENCES PUBLIC.PRZEDMIOT(ID),
    CONSTRAINT UQ_WW UNIQUE(PRZEDMIOT_ID, WYMAGANY_PRZEDMIOT_ID),
    CONSTRAINT CHK_WW_NOT_SELF CHECK(PRZEDMIOT_ID != WYMAGANY_PRZEDMIOT_ID)
);

CREATE TABLE PUBLIC.ZGODA_PROWADZACEGO(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    STUDENT_ID INTEGER NOT NULL,
    PRZEDMIOT_ID INTEGER NOT NULL,
    PROWADZACY_ID INTEGER NOT NULL,
    DATA_WYDANIA DATE NOT NULL,
    UWAGI VARCHAR(255),
    CONSTRAINT FK_ZP_STUDENT FOREIGN KEY(STUDENT_ID) REFERENCES PUBLIC.STUDENT(ID),
    CONSTRAINT FK_ZP_PRZEDMIOT FOREIGN KEY(PRZEDMIOT_ID) REFERENCES PUBLIC.PRZEDMIOT(ID),
    CONSTRAINT FK_ZP_PROWADZACY FOREIGN KEY(PROWADZACY_ID) REFERENCES PUBLIC.PROWADZACY(ID),
    CONSTRAINT UQ_ZP UNIQUE(STUDENT_ID, PRZEDMIOT_ID)
);

CREATE TABLE PUBLIC.SALA(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    BUDYNEK VARCHAR(50) NOT NULL,
    NUMER VARCHAR(20) NOT NULL,
    POJEMNOSC INTEGER NOT NULL,
    CONSTRAINT UQ_SALA UNIQUE(BUDYNEK, NUMER)
);

CREATE TABLE PUBLIC.ZAJECIA(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    PRZEDMIOT_ID INTEGER NOT NULL,
    PROWADZACY_ID INTEGER NOT NULL,
    SALA_ID INTEGER NOT NULL,
    TYP VARCHAR(10) NOT NULL,
    DZIEN_TYGODNIA INTEGER NOT NULL,
    GODZINA_OD TIME NOT NULL,
    GODZINA_DO TIME NOT NULL,
    SEMESTR INTEGER NOT NULL,
    LIMIT_MIEJSC INTEGER NOT NULL,
    CONSTRAINT FK_ZAJ_PRZEDMIOT FOREIGN KEY(PRZEDMIOT_ID) REFERENCES PUBLIC.PRZEDMIOT(ID),
    CONSTRAINT FK_ZAJ_PROWADZACY FOREIGN KEY(PROWADZACY_ID) REFERENCES PUBLIC.PROWADZACY(ID),
    CONSTRAINT FK_ZAJ_SALA FOREIGN KEY(SALA_ID) REFERENCES PUBLIC.SALA(ID),
    CONSTRAINT CHK_ZAJ_DZIEN CHECK(DZIEN_TYGODNIA BETWEEN 1 AND 7),
    CONSTRAINT CHK_ZAJ_GODZ CHECK(GODZINA_OD < GODZINA_DO)
);

CREATE TABLE PUBLIC.OKNO_ZAPISOW(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    SEMESTR INTEGER NOT NULL,
    START_TS TIMESTAMP NOT NULL,
    KONIEC_TS TIMESTAMP NOT NULL,
    OPIS VARCHAR(255),
    CONSTRAINT CHK_OKNO_TS CHECK(START_TS < KONIEC_TS),
    CONSTRAINT UQ_OKNO UNIQUE(SEMESTR, START_TS, KONIEC_TS)
);

CREATE TABLE PUBLIC.ZAPIS(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    STUDENT_ID INTEGER NOT NULL,
    ZAJECIA_ID INTEGER NOT NULL,
    DATA_ZAPISU TIMESTAMP NOT NULL,
    STATUS VARCHAR(15) NOT NULL,
    ZAPISAL_ADMIN_ID INTEGER,
    CONSTRAINT FK_ZAPIS_STUDENT FOREIGN KEY(STUDENT_ID) REFERENCES PUBLIC.STUDENT(ID),
    CONSTRAINT FK_ZAPIS_ZAJECIA FOREIGN KEY(ZAJECIA_ID) REFERENCES PUBLIC.ZAJECIA(ID),
    CONSTRAINT FK_ZAPIS_ADMIN FOREIGN KEY(ZAPISAL_ADMIN_ID) REFERENCES PUBLIC.UZYTKOWNIK(ID),
    CONSTRAINT UQ_ZAPIS UNIQUE(STUDENT_ID, ZAJECIA_ID)
);

CREATE TABLE PUBLIC.OCENA(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    STUDENT_ID INTEGER NOT NULL,
    PRZEDMIOT_ID INTEGER NOT NULL,
    SEMESTR INTEGER NOT NULL,
    WARTOSC VARCHAR(10) NOT NULL,
    PUNKTY INTEGER,
    RODZAJ VARCHAR(20) NOT NULL,
    DATA_WYSTAWIENIA DATE NOT NULL,
    PROWADZACY_ID INTEGER NOT NULL,
    CONSTRAINT FK_OC_STUDENT FOREIGN KEY(STUDENT_ID) REFERENCES PUBLIC.STUDENT(ID),
    CONSTRAINT FK_OC_PRZEDMIOT FOREIGN KEY(PRZEDMIOT_ID) REFERENCES PUBLIC.PRZEDMIOT(ID),
    CONSTRAINT FK_OC_PROWADZACY FOREIGN KEY(PROWADZACY_ID) REFERENCES PUBLIC.PROWADZACY(ID)
);

CREATE TABLE PUBLIC.NALEZNOSC(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    STUDENT_ID INTEGER NOT NULL,
    TYP VARCHAR(20) NOT NULL,
    KWOTA DECIMAL(10,2) NOT NULL,
    TERMIN DATE NOT NULL,
    STATUS VARCHAR(20) NOT NULL,
    OPIS VARCHAR(255),
    CONSTRAINT FK_NAL_STUDENT FOREIGN KEY(STUDENT_ID) REFERENCES PUBLIC.STUDENT(ID)
);

CREATE TABLE PUBLIC.WPLATA(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    NALEZNOSC_ID INTEGER NOT NULL,
    KWOTA DECIMAL(10,2) NOT NULL,
    DATA_WPLATY TIMESTAMP NOT NULL,
    REFERENCJA VARCHAR(80),
    CONSTRAINT FK_WPL_NALEZNOSC FOREIGN KEY(NALEZNOSC_ID) REFERENCES PUBLIC.NALEZNOSC(ID)
);

CREATE TABLE PUBLIC.KSIAZKA(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    ISBN VARCHAR(20),
    TYTUL VARCHAR(255) NOT NULL,
    AUTOR VARCHAR(255) NOT NULL,
    ROK INTEGER,
    CONSTRAINT UQ_KSIAZKA_ISBN UNIQUE(ISBN)
);

CREATE TABLE PUBLIC.WYPOZYCZENIE(
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    STUDENT_ID INTEGER NOT NULL,
    KSIAZKA_ID INTEGER NOT NULL,
    DATA_WYPOZYCZENIA DATE NOT NULL,
    TERMIN_ZWROTU DATE NOT NULL,
    DATA_ZWROTU DATE,
    STATUS VARCHAR(20) NOT NULL,
    CONSTRAINT FK_WYP_STUDENT FOREIGN KEY(STUDENT_ID) REFERENCES PUBLIC.STUDENT(ID),
    CONSTRAINT FK_WYP_KSIAZKA FOREIGN KEY(KSIAZKA_ID) REFERENCES PUBLIC.KSIAZKA(ID),
    CONSTRAINT CHK_WYP_TERMIN CHECK(DATA_WYPOZYCZENIA <= TERMIN_ZWROTU)
);